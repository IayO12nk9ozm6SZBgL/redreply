<!DOCTYPE html>
<html lang="zh-CN">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>红色问答调试</title>
   <style>
    html,body{
        width: 100%;
        height: 100%;
        display: flex;
        margin: 0;
        padding: 0;
    }
   </style>
   <script src="axios.js"></script>
   <script src="vue.js"></script>
   <script src="vue-quill.js"></script>
   <link rel="stylesheet" href="vue-quill.snow.prod.css">
</head>

<body>
   
   <div id="app" style="padding:0.5em; border: 1px solid;margin: 0.2em;display: flex;flex-direction: column;flex-grow: 1;">
        <h1 style="text-align: center;color: red;">红色问答调试</h1>
        <div style="display: flex; flex-direction: row;">
            <div style="display: flex;flex-direction: column;">
                <span>平台:</span>
                <span>机器人ID:</span>
                <span>群组ID:</span>
                <span>群ID:</span>
                <span>用户ID:</span>
            </div>
            <div style="display: flex;flex-direction: column;flex-grow: 1;">
                <input v-model = "platform"></input>
                <input v-model = "bot_id"></input>
                <input v-model = "groups_id" disabled></input>
                <input v-model = "group_id"></input>
                <input v-model = "user_id"></input>
            </div>
        </div>
        <div style="height: 0; flex-grow: 1;display: flex;flex-direction: column;flex-grow: 1;">
            <quill-editor id = "script_content"  ref="child" theme="snow" spellcheck = false style="flex-grow: 1; height: 0;"></quill-editor>
            <button style="height: 40px;font-size: medium;font-weight: bold;" @click="run_script()">发送到平台</button>
            <button style="height: 40px;font-size: medium;font-weight: bold;" @click="run_script2()">直接运行</button>
            <div style="display: flex;flex: 1 0 auto;height: 0;flex-direction: row;overflow: scroll;">
                <textarea style="flex-grow: 1;min-width: 50%;" disabled>{{result}}</textarea>
                <div v-if="has_img" style="overflow: scroll;width: 0;flex-grow: 1;">
                    <img v-bind:src="img_src" object-fit: scale-down></img>
                </div>
            </div>
            
        </div>
        </body>
        
   </div>
   <script>
    const { createApp } = Vue
    const app = createApp({
        data() {
            return {
                // 用于显示
                platform:"onebot11",
                bot_id:"1736293901",
                groups_id:"暂不支持",
                group_id:"920220179",
                user_id:"",
                result:"",
                img_src:"",
                has_img:false
            }
        },
        mounted () {
            // 对复制进行hook，解决复制时多余的换行
            ele = document.getElementById("script_content")
            ele.oncopy = (e) => {
                quill = this.$refs.child.getQuill()
                range = quill.getSelection()
                e.clipboardData.setData('text/plain', quill.getText(range.index, range.length));
                e.preventDefault();
            }
            
            // 处理中文输入
            ele.addEventListener('compositionstart',(e) =>{
                this.composing = true
                console.log('compositionstart')
            })
            ele.addEventListener('compositionend',(e) =>{    
                this.composing = false
                console.log('compositionend')
                this.highlight()
            })

            quill = this.$refs.child.getQuill()
            quill.on('text-change', (delta, oldDelta, source) => {
                if (source == 'user') {
                    if(!this.composing){
                        this.highlight()
                    }
                }
            });
        },
        methods: {
            run_script(){
                let content = this.$refs.child.getQuill().getText();
                let script = {
                    "platform":this.platform,
                    "bot_id":this.bot_id,
                    "groups_id":this.groups_id,
                    "group_id":this.group_id,
                    "user_id":this.user_id,
                    "content":content
                }
                this.result = "正在提交..."
                axios.post("/run_code",script)
                .then((res) => {
                    if(res.data['retcode'] == 0){
                        this.result = "请求已提交"
                    }else {
                        this.result = "提交失败：" + res.data
                    }
                })
                .catch(function (error) {
                    this.result = "提交失败"
                });
            },
            run_script2(){
                let content = this.$refs.child.getQuill().getText();
                let script = {
                    "platform":this.platform,
                    "bot_id":this.bot_id,
                    "groups_id":this.groups_id,
                    "group_id":this.group_id,
                    "user_id":this.user_id,
                    "content":content
                }
                this.result = "正在执行..."
                this.has_img = false
                axios.post("/run_code_and_ret",script)
                .then((res) => {
                    if(res.data['retcode'] == 0){
                        this.result = res.data["data"]
                        var reg = /\[CQ:image,file=(.*?)(\]|\,)/;
                        ret = reg.exec(this.result)
                        if(ret.length > 1) {
                            img = ret[1].trim()
                            if(img.startsWith("base64://")) {
                                this.img_src = "data:image/jpeg;base64," + img.slice(9)
                                this.has_img = true;
                            }else {
                                this.img_src = img
                                this.has_img = true;
                            }
                        }
                        console.log();
                    }else {
                        this.result = "执行失败：" + res.data['data']
                    }
                })
                .catch(function (error) {
                    this.result = "执行失败"
                });
            },
            highlight()
            {
                var current_color = 0;
                function next_color(){
                    current_color = (current_color + 1) % 4;
                }
                function pre_color(){
                    current_color = (current_color + 3) % 4;
                }
                function make_red_value(quill,index){
                    format = quill.getFormat(index,1)
                    if('color' in format){
                        if(format['color'] =='red'){
                            return;
                        }
                    }
                    quill.formatText(index,1, 'color','red')
                }
                function make_black_value(quill,index){
                    format = quill.getFormat(index,1)
                    if('color' in format){
                        if(format['color'] =='black'){
                            return;
                        }
                    }else {
                        return;
                    }
                    quill.formatText(index,1, 'color','black')
                }
                function make_blue_value(quill,index){
                    format = quill.getFormat(index,1)
                    if('color' in format){
                        if(format['color'] =='blue'){
                            return;
                        }
                    }
                    quill.formatText(index,1, 'color','blue')
                }
                function make_green_value(quill,index){
                    format = quill.getFormat(index,1)
                    if('color' in format){
                        if(format['color'] =='green'){
                            return;
                        }
                    }
                    quill.formatText(index,1, 'color','green')
                }
                var colorList = [make_black_value,make_red_value,make_green_value,make_blue_value]
                function out_text(quill,index){
                    colorList[current_color](quill,index)
                }

                quill = this.$refs.child.getQuill();

                let code = quill.getText();
                for(let i = 0;i<code.length;i++){
                    if(code[i] == "【"){
                        next_color()
                        out_text(quill,i)
                    }
                    else if(code[i] == "】"){
                        out_text(quill,i)
                        pre_color()
                    }
                    else if(code[i] == "\\"){
                        out_text(quill,i)
                        i += 1
                        out_text(quill,i)
                    }
                    else{
                        out_text(quill,i)
                    }
                }
            },
        }
    })
    const globalOptions = {
        modules: {
        toolbar: ""
        },
        placeholder: '脚本内容',
        theme: 'snow'
    }
    VueQuill.QuillEditor.props.globalOptions.default = () => globalOptions
    app.component('QuillEditor', VueQuill.QuillEditor);
    app.mount('#app')
   </script>
   
</body>

</html>